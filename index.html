<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Management</title>
    <style>
        /* General Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f9; /* Light background */
            color: #333;
        }

        /* Buttons Styling */
        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }

        #btnStu {
            background-color: #007bff; /* Primary blue */
            color: white;
        }

        #btnStu:hover {
            background-color: #0056b3;
        }

        #btn-modal {
            background-color: #28a745; /* Success green */
            color: white;
            margin-left: 0; /* Align with fetch button */
        }

        #btn-modal:hover {
            background-color: #1e7e34;
        }

        /* Content Area */
        #contents {
            margin-top: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #contents > div {
            /* Container for product items */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Individual Product Item */
        #contents > div > div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background-color: #fcfcfc;
            border-radius: 4px;
            transition: background-color 0.1s;
        }

        #contents > div > div:last-child {
            border-bottom: none;
        }

        #contents > div > div:hover {
            background-color: #f9f9f9;
        }

        .content {
            /* Product info text */
            flex-grow: 1;
            font-size: 16px;
            color: #555;
            padding: 0;
            float: none; /* Remove float */
            width: auto; /* Remove fixed width */
            height: auto;
        }

        /* Modify/Delete Buttons */
        #contents button {
            margin-left: 10px;
            padding: 8px 12px;
            font-size: 14px;
        }

        #contents button:nth-of-type(1) { /* Modify button */
            background-color: #ffc107; /* Yellow */
            color: #333;
        }

        #contents button:nth-of-type(1):hover {
            background-color: #e0a800;
        }

        #contents button:nth-of-type(2) { /* Delete button */
            background-color: #dc3545; /* Red */
            color: white;
        }

        #contents button:nth-of-type(2):hover {
            background-color: #bd2130;
        }

        /* --- Modal Styles (Overhaul) --- */

        .modal {
            background-color: rgba(0, 0, 0, 0.5); /* Slightly lighter overlay */
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;

            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000; /* Ensure it's above other content */

            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0; /* Remove padding from modal overlay */
        }

        .modal-content {
            max-width: 450px; /* Slightly adjusted max-width */
            width: 90%; /* Responsive width */
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            padding: 20px;
            
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncier transition */
            transform: scale(0.7);
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal.show .modal-content {
            opacity: 1;
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding: 0 0 15px 0;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin: 0;
            padding: 0;
        }

        .btn-close {
            color: #999;
            font-size: 32px;
            font-weight: normal;
            cursor: pointer;
            padding: 5px; /* Increase click area */
            line-height: 1; /* Center the 'x' */
            transition: color 0.2s;
        }

        .btn-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 10px 0;
        }

        .modal-body .modal-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box; /* Include padding/border in element's total width */
            font-size: 16px;
        }

        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Modal Footer Buttons */
        .modal-footer button {
            padding: 8px 15px;
            margin: 0;
        }

        .modal-footer button:nth-of-type(1) { /* Close Button */
            background-color: #6c757d; /* Secondary gray */
            color: white;
        }

        .modal-footer button:nth-of-type(1):hover {
            background-color: #5a6268;
        }

        .modal-footer button:nth-of-type(2), 
        #btn-Add, #btn-Save { /* Add data / Save changes Button */
            background-color: #007bff; /* Primary blue */
            color: white;
        }
        
        #btn-Save {
             background-color: #28a745; /* Green for Save */
        }
        
        #btn-Save:hover {
            background-color: #1e7e34;
        }

        .modal-footer button:nth-of-type(2):hover {
            background-color: #0056b3;
        }
        
        /* Utility */
        input[type="text"]::placeholder {
            color: #aaa;
        }

    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // elements (Add Modal)
            var modalBtn = document.getElementById("btn-modal");
            var addModal = document.getElementById("addModal");
            var closeAddBtn = document.getElementById("btn-close"); // btn-close는 addModal의 닫기 버튼

            // elements (Edit Modal)
            var editModal = document.getElementById("editModal");
            var closeEditBtn = document.getElementById("btn-edit-close"); // 수정 모달의 닫기 버튼

            // functions
            function toggleAddModal() {
                addModal.classList.toggle("show");
            }
            function toggleEditModal() {
                editModal.classList.toggle("show");
            }

            // events
            modalBtn.addEventListener("click", toggleAddModal);
            closeAddBtn.addEventListener("click", toggleAddModal);
            closeEditBtn.addEventListener("click", toggleEditModal); // 수정 모달 닫기 이벤트

            window.addEventListener("click", function (event) {
                // 모달의 검은색 배경 부분이 클릭된 경우 닫히도록 하는 코드
                if (event.target === addModal) {
                    toggleAddModal();
                }
                if (event.target === editModal) { // 수정 모달 배경 클릭 시 닫기
                    toggleEditModal();
                }
            });
        });

        window.onload = function () {
            //getStudents();
            let btnStu = document.getElementById("btnStu");
            let btnAdd = document.getElementById("btn-Add");
            let btnSave = document.getElementById("btn-Save"); // 저장 버튼 변수 추가

            var addModal = document.getElementById("addModal");
            var editModal = document.getElementById("editModal"); // 수정 모달 변수 추가

            function toggleAddModal() {
                addModal.classList.toggle("show");
            }
            function toggleEditModal() {
                editModal.classList.toggle("show");
            }

            btnStu.addEventListener("click", function (event) {
                getStudents();
            });
            btnAdd.addEventListener("click", function (event) {
                postData();
                // toggleAddModal(); // postData 성공 후 닫도록 변경할 수 있음
            });
            btnSave.addEventListener("click", function (event) { // 저장 버튼 이벤트 추가
                saveData(); // 데이터를 저장(PUT)하는 함수 호출
                // toggleEditModal(); // saveData 성공 후 닫도록 변경할 수 있음
            });
        };

        function getStudents() {
            const xhr = new XMLHttpRequest();

            xhr.onload = () => {
                if (xhr.status === 200) {
                    const res = JSON.parse(xhr.response);
                    // contents 변수가 없으므로, ID로 직접 가져옵니다.
                    document.getElementById('contents').innerHTML = makeList(res);
                } else {
                    console.log(xhr.status, xhr.statusText);
                }
            };

            xhr.open("GET", "https://6909a7ab2d902d0651b49af9.mockapi.io/SampleProduct");
            xhr.setRequestHeader("content-type", "application/json");
            xhr.send();
        }

        function postData() {
            let product = document.getElementById("product");
            let price = document.getElementById("price");
            let material = document.getElementById("material");
            let count = document.getElementById("count");

            if (!product.value.trim() || !price.value.trim() || !material.value.trim() || !count.value.trim()) {
                alert("Please fill in all fields.");
                return;
            }

            const xhr = new XMLHttpRequest();
            var addModal = document.getElementById("addModal");

            xhr.onload = () => {
                if (xhr.status == 201) {
                    product.value = "";
                    price.value = "";
                    material.value = "";
                    count.value = "";
                    getStudents();
                    addModal.classList.remove("show"); // 성공 시 모달 닫기
                } else {
                    console.log(xhr.status, xhr.statusText);
                    alert("Failed to add product: " + xhr.statusText);
                }
            };

            xhr.open("POST", "https://6909a7ab2d902d0651b49af9.mockapi.io/SampleProduct");
            xhr.setRequestHeader("content-type", "application/json; charset=UTF-8");
            const data = { product: product.value, price: price.value, material: material.value, count: count.value };
            xhr.send(JSON.stringify(data));
        }

        function deleteData(id) {
            if (!confirm("Do you really want to delete?")) {
                return;
            }

            const xhr = new XMLHttpRequest();
            xhr.open("DELETE", "https://6909a7ab2d902d0651b49af9.mockapi.io/SampleProduct/" + id);
            xhr.setRequestHeader("content-type", "application/json; charset=UTF-8");
            xhr.send();

            xhr.onload = () => {
                if (xhr.status === 200) {
                    const res = JSON.parse(xhr.response);
                    console.log("Deleted:", res);
                    getStudents();
                } else {
                    console.log(xhr.status, xhr.statusText);
                    alert("Failed to delete data: " + xhr.statusText);
                }
            };
        }

        // 수정: prompt 대신 데이터를 가져와 모달을 여는 방식으로 변경
        function updateData(id) {
            const xhr = new XMLHttpRequest();
            var editModal = document.getElementById("editModal");

            xhr.onload = () => {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.response);

                    // 1. 모달 필드에 현재 데이터 채우기 (ID: edit-product 등으로 변경됨)
                    document.getElementById("edit-product").value = data.product;
                    document.getElementById("edit-price").value = data.price;
                    document.getElementById("edit-material").value = data.material;
                    document.getElementById("edit-count").value = data.count;

                    // 2. 수정할 ID 저장 (저장 버튼 클릭 시 사용)
                    document.getElementById("edit-id-holder").value = id;

                    // 3. 모달 열기
                    editModal.classList.add("show");

                } else {
                    console.log(xhr.status, xhr.statusText);
                    alert("Failed to fetch data for update: " + xhr.statusText);
                }
            };

            // 해당 ID의 데이터를 가져오기 위해 GET 요청을 보냅니다.
            xhr.open("GET", "https://6909a7ab2d902d0651b49af9.mockapi.io/SampleProduct/" + id);
            xhr.setRequestHeader("content-type", "application/json");
            xhr.send();
        }

        // 수정된 데이터를 PUT 요청으로 저장하는 새로운 함수
        function saveData() {
            // 1. 모달에서 수정된 값과 ID 가져오기
            const id = document.getElementById("edit-id-holder").value;
            const newProduct = document.getElementById("edit-product").value;
            const newPrice = document.getElementById("edit-price").value;
            const newMaterial = document.getElementById("edit-material").value;
            const newCount = document.getElementById("edit-count").value;
            var editModal = document.getElementById("editModal");

            // 간단한 유효성 검사
            if (!newProduct.trim() || !newPrice.trim() || !newMaterial.trim() || !newCount.trim()) {
                alert("All fields must be filled out.");
                return;
            }
            
            // 숫자로 변환 가능한지 확인 (선택 사항이지만 유효성 강화)
            const priceValue = Number(newPrice);
            const countValue = Number(newCount);
            if (isNaN(priceValue) || isNaN(countValue)) {
                 alert("Price and Count must be valid numbers.");
                 return;
            }

            const xhr = new XMLHttpRequest();

            xhr.onload = () => {
                if (xhr.status === 200) {
                    console.log("Data updated successfully.");
                    getStudents(); // 리스트 갱신
                    editModal.classList.remove("show"); // 성공 시 모달 닫기
                } else {
                    console.log(xhr.status, xhr.statusText);
                    alert("Fail update data: " + xhr.statusText);
                }
            };

            xhr.open("PUT", "https://6909a7ab2d902d0651b49af9.mockapi.io/SampleProduct/" + id);
            xhr.setRequestHeader("content-type", "application/json; charset=UTF-8");

            const data = {
                product: newProduct,
                price: priceValue,
                material: newMaterial,
                count: countValue
            };

            xhr.send(JSON.stringify(data));
        }

        function makeList(data) {
            let str = "";
            for (key in data) {
                //console.log("Name :" + data[key].name + " , age :" + data[key].age);
                str +=
                    "<div id='" +
                    data[key].id +
                    "'><div class='content'>" +
                    data[key].product +
                    " x " +
                    data[key].count +
                    " (" +
                    data[key].material +
                    ")" +
                    " [$" +
                    data[key].price +
                    "] </div>" +
                    "<button onclick='updateData(\"" + // updateData 함수는 이제 모달을 엽니다.
                    data[key].id +
                    "\")'>Modify</button>" +
                    "<button onclick='deleteData(\"" +
                    data[key].id +
                    "\")'>Delete</button></div>";
            }
            // Add a message if no data is present
            if (data.length === 0) {
                 str = "<div style='text-align: center; color: #999; padding: 30px;'>No products found. Click 'Bring product data' to fetch or 'Add New Product' to create one.</div>";
            }
            str = "<div>" + str + "</div>";
            return str;
        }
    </script>
</head>

<body>
    <h1>Product Inventory Management</h1>
    <button id="btnStu">Bring product data</button>
    
    <button id="btn-modal" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
        Add New Product
    </button>
    
    <div id="contents">
        <div style='text-align: center; color: #999; padding: 30px;'>
            Click "Bring product data" to load the list.
        </div>
    </div>


    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addModalLabel">Add New Product</h1>
                    <span class="btn-close" id="btn-close">&times;</span>
                </div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="product" size="10" placeholder="Product Name" />
                    <input type="text" class="modal-input" id="price" size="5" placeholder="Price (e.g., 19.99)" />
                    <input type="text" class="modal-input" id="material" size="5" placeholder="Material" />
                    <input type="text" class="modal-input" id="count" size="5" placeholder="Count (Quantity)" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="btn-Add" class="btn">Add data</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="editModalLabel">Modify Product</h1>
                    <span class="btn-close" id="btn-edit-close">&times;</span>
                </div>
                <div class="modal-body">
                    <input type="text" class="modal-input" id="edit-product" size="10" placeholder="Product Name" />
                    <input type="text" class="modal-input" id="edit-price" size="5" placeholder="Price (e.g., 19.99)" />
                    <input type="text" class="modal-input" id="edit-material" size="5" placeholder="Material" />
                    <input type="text" class="modal-input" id="edit-count" size="5" placeholder="Count (Quantity)" />
                    <input type="hidden" id="edit-id-holder" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="btn-Save" class="btn">Save changes</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>